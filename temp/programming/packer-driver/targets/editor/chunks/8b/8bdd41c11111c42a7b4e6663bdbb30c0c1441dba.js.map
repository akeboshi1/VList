{"version":3,"sources":["file:///D:/workspace/cocosworkspace/dynamicListZip/assets/test/DynamicList.ts"],"names":["_decorator","Component","instantiate","Node","Prefab","ScrollView","Size","UITransform","v2","v3","ccclass","property","DynamicList","displayName","renderInfos","itemPool","renderer","start","scrollView","on","EventType","SCROLLING","refreshView","setData","args","forEach","e","push","item","active","content","getComponent","setAnchorPoint","totalHeight","paddingTop","itemRenderer","dataList","length","pop","itemPrefab","onInstantiate","parent","position","height","space","data","isVisible","contentTrans","setContentSize","width","contentPos","viewSize","view","contentSize","viewTopY","y","viewBottomY","currentY","i","info","itemHeight","dirty","itemTopY","itemBottomY","isInView","setPosition","paddingLeft","clear","destroy"],"mappings":"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","sourcesContent":["import { _decorator, Component, instantiate, Node, Prefab, ScrollView, Size, UITransform, v2, v3 } from 'cc';\r\nconst { ccclass, property } = _decorator;\r\ninterface IRenderItemInfo {\r\n    item: Node;\r\n    data: any;\r\n    height: number;\r\n    isVisible: boolean;\r\n}\r\n@ccclass('DynamicList')\r\nexport class DynamicList extends Component {\r\n    @property(Prefab)\r\n    itemPrefab: Prefab;\r\n    @property(Node)\r\n    scrollView: Node;\r\n    @property(Node)\r\n    view: Node;\r\n    @property(Node)\r\n    content: Node;\r\n    @property\r\n    space: number = 10;\r\n    @property({ displayName: \"左侧留白\" })\r\n    paddingLeft: number = 0;\r\n    @property({ displayName: \"上侧留白\" })\r\n    paddingTop: number = 0;\r\n\r\n\r\n    renderInfos: IRenderItemInfo[] = [];\r\n    itemPool: Node[] = [];\r\n    renderer: (itemNode: Node, data: any[]) => void;\r\n    protected start(): void {\r\n        this.scrollView.on(ScrollView.EventType.SCROLLING, this.refreshView, this);\r\n    }\r\n    public setData(args: {\r\n        dataList: {\r\n            height: number;\r\n            data: any;\r\n        }[],\r\n        itemRenderer: (itemNode: Node, data: any[]) => void,\r\n        onInstantiate: (itemNode: Node) => void,\r\n    }) {\r\n        this.renderInfos.forEach(e => {\r\n            this.itemPool.push(e.item);\r\n            e.item.active = false;\r\n        });\r\n        this.content.getComponent(UITransform).setAnchorPoint(v2(0, 1));\r\n        this.renderInfos = [];\r\n        let totalHeight = this.paddingTop;\r\n        this.renderer = args.itemRenderer;\r\n        args.dataList.forEach(e => {\r\n            let item: Node = null;\r\n            if (this.itemPool.length > 0) {\r\n                item = this.itemPool.pop();\r\n            }\r\n            else {\r\n                item = instantiate(this.itemPrefab);\r\n                args.onInstantiate(item);\r\n            }\r\n            item.parent = this.content;\r\n            item.getComponent(UITransform).setAnchorPoint(0, 1);\r\n            item.position = v3(0, -totalHeight, 0);\r\n            totalHeight += e.height + this.space;\r\n            this.renderInfos.push({\r\n                height: e.height,\r\n                item,\r\n                data: e.data,\r\n                isVisible: false\r\n            });\r\n        });\r\n        let contentTrans = this.content.getComponent(UITransform);\r\n        contentTrans.setContentSize(new Size(contentTrans.width, totalHeight));\r\n        this.refreshView();\r\n    }\r\n    refreshView(): void {\r\n        let contentPos = this.content.position;\r\n        let viewSize = this.view.getComponent(UITransform).contentSize;\r\n        if (this.renderInfos.length === 0) return;\r\n        const viewTopY = this.view.position.y + viewSize.height / 2;\r\n        const viewBottomY = this.view.position.y - viewSize.height / 2;\r\n        let currentY = -this.paddingTop;\r\n        for (let i = 0; i < this.renderInfos.length; i++) {\r\n            const info = this.renderInfos[i];\r\n            const itemHeight = info.height;\r\n            const item = info.item;\r\n            let dirty = false;\r\n            const itemTopY = currentY + contentPos.y;\r\n            const itemBottomY = currentY - itemHeight + contentPos.y;\r\n            const isInView = (\r\n                itemBottomY < viewTopY + this.space &&\r\n                itemTopY > viewBottomY - this.space\r\n            );\r\n            if (!info.isVisible && isInView)\r\n                dirty = true;\r\n            item.active = isInView;\r\n            info.isVisible = isInView;\r\n            if (isInView) {\r\n                item.setPosition(-viewSize.width / 2 + this.paddingLeft, currentY);\r\n            }\r\n            if (dirty)\r\n                this.renderer(item, info.data);\r\n\r\n            currentY -= itemHeight + this.space;\r\n        }\r\n    }\r\n    clear() {\r\n        this.renderInfos.forEach(e => {\r\n            e.item.destroy();\r\n        });\r\n        this.renderInfos = [];\r\n        this.itemPool.forEach(e => e.destroy());\r\n        this.itemPool = [];\r\n\r\n    }\r\n}\r\n\r\n\r\n"]}