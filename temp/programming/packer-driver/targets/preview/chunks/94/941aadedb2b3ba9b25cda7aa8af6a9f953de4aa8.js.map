{"version":3,"sources":["file:///D:/workspace/cocosworkspace/dynamicListZip/assets/core/FixedScrollView.ts"],"names":["_decorator","easing","ScrollView","UITransform","v2","v3","Vec3","ccclass","property","EPSILON","FixedScrollView","isInTouch","isOutOfBoundary","_isOutOfBoundary","scrollAnchor","offset","getScrollOffset","max","getMaxScrollOffset","x","y","_getHowMuchOutOfBoundary","addition","isInfinity","_calculateMovePercentDelta","options","anchor","applyToHorizontal","applyToVertical","self","_calculateBoundary","bottomDelta","_getContentBottomBoundary","_bottomBoundary","leftDelta","_getContentLeftBoundary","_leftBoundary","moveDelta","_content","view","totalScrollDelta","uiTrans","getComponent","contentSize","scrollSize","width","height","_processAutoScrolling","dt","isAutoScrollBrake","_isNecessaryAutoScrollBrake","brakingFactor","_autoScrollAccumulatedTime","percentage","Math","min","_autoScrollTotalTime","_autoScrollAttenuate","quintOut","clonedAutoScrollTargetDelta","_autoScrollTargetDelta","clone","multiplyScalar","clonedAutoScrollStartPosition","_autoScrollStartPosition","add","reachedEnd","abs","fireEvent","getScrollEndedEventTiming","_isScrollEndedWithThresholdEventFired","_dispatchEvent","EventType","SCROLL_ENG_WITH_THRESHOLD","elastic","brakeOffsetPosition","subtract","_autoScrollBrakingStartPosition","set","getContentPosition","outOfBoundary","equals","ZERO","_autoScrolling","deltaMove","content","position","_clampDelta","_moveContent","length","SCROLLING","_isBouncing","_scrolling","SCROLL_ENDED","node","emit","FINISH_AUTO_SCROLL","out","_handleReleaseLogic","touch","_getLocalAxisAlignDelta","_deltaPos","_gatherTouchMove","isHandleReleaseScroll","_processInertiaScroll","_onTouchBegan","event","captureListeners","allowTouch","_onTouchMoved","_onTouchCancelled","simulate","TOUCH_UP","_onTouchEnded","_hasNestedViewGroup"],"mappings":";;;;;;;;;;;;;;;;AAASA,MAAAA,U,OAAAA,U;AAAYC,MAAAA,M,OAAAA,M;AAA0BC,MAAAA,U,OAAAA,U;AAAmBC,MAAAA,W,OAAAA,W;AAAaC,MAAAA,E,OAAAA,E;AAAIC,MAAAA,E,OAAAA,E;AAAIC,MAAAA,I,OAAAA,I;;;;;;;;;OACjF;AAAEC,QAAAA,OAAF;AAAWC,QAAAA;AAAX,O,GAAwBR,U;AACxBS,MAAAA,O,GAAU,K;;iCAEHC,e,WADZH,OAAO,CAAC,iBAAD,C,sCAAR,MACaG,eADb,SACqCR,UADrC,CACgD;AAAA;AAAA;;AAAA;;AAAA;;AAAA;;AAAA,eAO5CS,SAP4C,GAOvB,KAPuB;AAAA;;AASzB,YAAfC,eAAe,GAAG;AAClB,iBAAO,KAAKC,gBAAL,EAAP;AACH;;AACe,YAAZC,YAAY,GAAG;AACf,cAAIC,MAAM,GAAG,KAAKC,eAAL,EAAb;AACA,cAAIC,GAAG,GAAG,KAAKC,kBAAL,EAAV;AACA,iBAAOd,EAAE,CAACa,GAAG,CAACE,CAAJ,IAAS,CAAT,GAAa,CAAb,GAAiBJ,MAAM,CAACI,CAAP,GAAWF,GAAG,CAACE,CAAjC,EAAoCF,GAAG,CAACG,CAAJ,IAAS,CAAT,GAAa,CAAb,GAAiB,IAAIL,MAAM,CAACK,CAAP,GAAWH,GAAG,CAACG,CAAxE,CAAT;AACH;;AAESC,QAAAA,wBAAwB,CAACC,QAAD,EAAwB;AACtD,cAAI,KAAKC,UAAT,EACI,OAAOlB,EAAE,EAAT,CADJ,KAGI,OAAO,MAAMgB,wBAAN,CAA+BC,QAA/B,CAAP;AACP;;AACSE,QAAAA,0BAA0B,CAACC,OAAD,EAAgB;AAChD,cAAMC,MAAM,GAAGD,OAAO,CAACC,MAAvB;AACA,cAAMC,iBAAiB,GAAGF,OAAO,CAACE,iBAAlC;AACA,cAAMC,eAAe,GAAGH,OAAO,CAACG,eAAhC,CAHgD,CAIhD;;AACA,cAAMC,IAAI,GAAG,IAAb;;AACAA,UAAAA,IAAI,CAACC,kBAAL,GANgD,CAOhD;;;AACA,cAAIC,WAAW,GAAGF,IAAI,CAACG,yBAAL,KAAmCH,IAAI,CAACI,eAA1D;;AACAF,UAAAA,WAAW,GAAG,CAACA,WAAf;;AAEA,cAAIG,SAAS,GAAGL,IAAI,CAACM,uBAAL,KAAiCN,IAAI,CAACO,aAAtD;;AACAF,UAAAA,SAAS,GAAG,CAACA,SAAb;AAEA,cAAMG,SAAS,GAAG,IAAI/B,IAAJ,EAAlB;;AACA,cAAIuB,IAAI,CAACS,QAAL,IAAiBT,IAAI,CAACU,IAA1B,EAAgC;AAC5B,gBAAIC,gBAAgB,GAAG,CAAvB;;AACA,gBAAMC,OAAO,GAAGZ,IAAI,CAACS,QAAL,CAAcI,YAAd,CAA2BvC,WAA3B,CAAhB;;AACA,gBAAMwC,WAAW,GAAGF,OAAO,CAACE,WAA5B;AACA,gBAAMC,UAAU,GAAGf,IAAI,CAACU,IAAL,CAAUI,WAA7B;;AACA,gBAAIhB,iBAAJ,EAAuB;AACnBa,cAAAA,gBAAgB,GAAGG,WAAW,CAACE,KAAZ,GAAoBD,UAAU,CAACC,KAAlD;AACAR,cAAAA,SAAS,CAAClB,CAAV,GAAce,SAAS,GAAGM,gBAAgB,GAAGd,MAAM,CAACP,CAApD;AACH;;AACD,gBAAIS,eAAJ,EAAqB;AACjBY,cAAAA,gBAAgB,GAAGG,WAAW,CAACG,MAAZ,GAAqBF,UAAU,CAACE,MAAnD;AACAT,cAAAA,SAAS,CAACjB,CAAV,GAAcW,WAAW,GAAGS,gBAAgB,GAAGd,MAAM,CAACN,CAAtD;AACH;AACJ;;AAED,iBAAOiB,SAAP;AACH;;AACSU,QAAAA,qBAAqB,CAACC,EAAD,EAAgB;AAC3C,cAAMnB,IAAI,GAAG,IAAb;;AAEA,cAAMoB,iBAAiB,GAAGpB,IAAI,CAACqB,2BAAL,EAA1B;;AACA,cAAMC,aAAa,GAAGF,iBAAiB,GAAG,IAAH,GAAU,CAAjD;AACApB,UAAAA,IAAI,CAACuB,0BAAL,IAAmCJ,EAAE,IAAI,IAAIG,aAAR,CAArC;AAEA,cAAIE,UAAU,GAAGC,IAAI,CAACC,GAAL,CAAS,CAAT,EAAY1B,IAAI,CAACuB,0BAAL,GAAkCvB,IAAI,CAAC2B,oBAAnD,CAAjB;;AACA,cAAI3B,IAAI,CAAC4B,oBAAT,EAA+B;AAC3BJ,YAAAA,UAAU,GAAGpD,MAAM,CAACyD,QAAP,CAAgBL,UAAhB,CAAb;AACH;;AAED,cAAMM,2BAA2B,GAAG9B,IAAI,CAAC+B,sBAAL,CAA4BC,KAA5B,EAApC;;AACAF,UAAAA,2BAA2B,CAACG,cAA5B,CAA2CT,UAA3C;;AACA,cAAMU,6BAA6B,GAAGlC,IAAI,CAACmC,wBAAL,CAA8BH,KAA9B,EAAtC;;AACAE,UAAAA,6BAA6B,CAACE,GAA9B,CAAkCN,2BAAlC;AACA,cAAIO,UAAU,GAAGZ,IAAI,CAACa,GAAL,CAASd,UAAU,GAAG,CAAtB,KAA4B5C,OAA7C;AAEA,cAAM2D,SAAS,GAAGd,IAAI,CAACa,GAAL,CAASd,UAAU,GAAG,CAAtB,KAA4BxB,IAAI,CAACwC,yBAAL,EAA9C;;AACA,cAAID,SAAS,IAAI,CAACvC,IAAI,CAACyC,qCAAvB,EAA8D;AAC1DzC,YAAAA,IAAI,CAAC0C,cAAL,CAAoBrE,UAAU,CAACsE,SAAX,CAAqBC,yBAAzC;;AACA5C,YAAAA,IAAI,CAACyC,qCAAL,GAA6C,IAA7C;AACH;;AAED,cAAIzC,IAAI,CAAC6C,OAAT,EAAkB;AACd,gBAAMC,mBAAmB,GAAGZ,6BAA6B,CAACF,KAA9B,EAA5B;AACAc,YAAAA,mBAAmB,CAACC,QAApB,CAA6B/C,IAAI,CAACgD,+BAAlC;;AACA,gBAAI5B,iBAAJ,EAAuB;AACnB0B,cAAAA,mBAAmB,CAACb,cAApB,CAAmCX,aAAnC;AACH;;AACDY,YAAAA,6BAA6B,CAACe,GAA9B,CAAkCjD,IAAI,CAACgD,+BAAvC;AACAd,YAAAA,6BAA6B,CAACE,GAA9B,CAAkCU,mBAAlC;AACH,WARD,MAQO;AACH,gBAAMtC,SAAS,GAAG0B,6BAA6B,CAACF,KAA9B,EAAlB;AACAxB,YAAAA,SAAS,CAACuC,QAAV,CAAmB/C,IAAI,CAACkD,kBAAL,EAAnB;;AACA,gBAAMC,aAAa,GAAGnD,IAAI,CAACR,wBAAL,CAA8BgB,SAA9B,CAAtB;;AACA,gBAAI,CAAC2C,aAAa,CAACC,MAAd,CAAqB3E,IAAI,CAAC4E,IAA1B,EAAgCzE,OAAhC,CAAL,EAA+C;AAC3CsD,cAAAA,6BAA6B,CAACE,GAA9B,CAAkCe,aAAlC;AACAd,cAAAA,UAAU,GAAG,IAAb;AACH;AACJ;;AAED,cAAIA,UAAJ,EAAgB;AACZrC,YAAAA,IAAI,CAACsD,cAAL,GAAsB,KAAtB;AACH;;AAED,cAAMC,SAAS,GAAGrB,6BAA6B,CAACF,KAA9B,EAAlB;AACAuB,UAAAA,SAAS,CAACR,QAAV,CAAmB/C,IAAI,CAACwD,OAAL,CAAaC,QAAhC;;AACAzD,UAAAA,IAAI,CAAC0D,WAAL,CAAiBH,SAAjB;;AACAvD,UAAAA,IAAI,CAAC2D,YAAL,CAAkBJ,SAAlB,EAA6BlB,UAA7B;;AACA,cAAIkB,SAAS,CAACK,MAAV,KAAqBhF,OAAzB,EACIoB,IAAI,CAAC0C,cAAL,CAAoBrE,UAAU,CAACsE,SAAX,CAAqBkB,SAAzC;;AAEJ,cAAI,CAAC7D,IAAI,CAACsD,cAAV,EAA0B;AACtBtD,YAAAA,IAAI,CAAC8D,WAAL,GAAmB,KAAnB;AACA9D,YAAAA,IAAI,CAAC+D,UAAL,GAAkB,KAAlB;;AACA/D,YAAAA,IAAI,CAAC0C,cAAL,CAAoBrE,UAAU,CAACsE,SAAX,CAAqBqB,YAAzC;;AACAhE,YAAAA,IAAI,CAACiE,IAAL,CAAUC,IAAV,CAAerF,eAAe,CAACsF,kBAA/B;AACH;AACJ;;AAEST,QAAAA,WAAW,CAACU,GAAD,EAAkB;AACnC,cAAI,CAAC,KAAK1E,UAAV,EACI,MAAMgE,WAAN,CAAkBU,GAAlB;AACP;;AAESC,QAAAA,mBAAmB,CAACC,KAAD,EAAqB;AAC9C;AACA,cAAMtE,IAAI,GAAG,IAAb;;AAEAA,UAAAA,IAAI,CAACuE,uBAAL,CAA6BvE,IAAI,CAACwE,SAAlC,EAA6CF,KAA7C;;AACAtE,UAAAA,IAAI,CAACyE,gBAAL,CAAsBzE,IAAI,CAACwE,SAA3B;;AACA,cAAIxE,IAAI,CAAC0E,qBAAL,IAA8B,KAAK1F,gBAAL,EAAlC,EACIgB,IAAI,CAAC2E,qBAAL;;AAEJ,cAAI3E,IAAI,CAAC+D,UAAT,EAAqB;AACjB/D,YAAAA,IAAI,CAAC+D,UAAL,GAAkB,KAAlB;;AACA,gBAAI,CAAC/D,IAAI,CAACsD,cAAV,EAA0B;AACtBtD,cAAAA,IAAI,CAAC0C,cAAL,CAAoBrE,UAAU,CAACsE,SAAX,CAAqBqB,YAAzC;AACH;AACJ;AACJ;;AACSY,QAAAA,aAAa,CAACC,KAAD,EAAoBC,gBAApB,EAAqD;AACxE,eAAKhG,SAAL,GAAiB,IAAjB;AACA,cAAI,CAAC,KAAKiG,UAAV,EACI;;AACJ,gBAAMH,aAAN,CAAoBC,KAApB,EAA2BC,gBAA3B;AACH;;AACSE,QAAAA,aAAa,CAACH,KAAD,EAAoBC,gBAApB,EAAqD;AACxE,cAAI,CAAC,KAAKC,UAAV,EACI;;AACJ,gBAAMC,aAAN,CAAoBH,KAApB,EAA2BC,gBAA3B;AAEH;;AACSG,QAAAA,iBAAiB,CAACJ,KAAD,EAAoBC,gBAApB,EAAqD;AAC5E,eAAKhG,SAAL,GAAiB,KAAjB;AACA,cAAI,CAAC,KAAKiG,UAAV,EACI;;AACJ,gBAAME,iBAAN,CAAwBJ,KAAxB,EAA+BC,gBAA/B;;AACA,cAAID,KAAK,IAAI,CAACA,KAAK,CAACK,QAApB,EAA8B;AAC1B,iBAAKxC,cAAL,CAAoBrE,UAAU,CAACsE,SAAX,CAAqBwC,QAAzC;AACH;AACJ;;AACSC,QAAAA,aAAa,CAACP,KAAD,EAAoBC,gBAApB,EAAqD;AACxE,eAAKhG,SAAL,GAAiB,KAAjB;AACA,cAAI,CAAC,KAAKiG,UAAV,EACI;;AACJ,gBAAMK,aAAN,CAAoBP,KAApB,EAA2BC,gBAA3B;AACH;;AAESO,QAAAA,mBAAmB,CAACR,KAAD,EAAaC,gBAAb,EAAiD;AAC1E;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA,iBAAO,KAAP;AACH;;AA5L2C,O,UAQ5BX,kB,GAAqB,kB,uFAPpCxF,Q;;;;;iBACqB,I;;gGACrBA,Q;;;;;iBACgC,I;;qFAChCA,Q;;;;;iBACqB,K","sourcesContent":["import { _decorator, easing, EventTouch, Node, ScrollView, Touch, UITransform, v2, v3, Vec3 } from 'cc';\nconst { ccclass, property } = _decorator;\nconst EPSILON = 0.001;\n@ccclass('FixedScrollView')\nexport class FixedScrollView extends ScrollView {\n    @property\n    allowTouch: boolean = true;\n    @property\n    isHandleReleaseScroll: boolean = true;\n    @property\n    isInfinity: boolean = false;\n    isInTouch: boolean = false;\n    static readonly FINISH_AUTO_SCROLL = \"finishAutoScroll\";\n    get isOutOfBoundary() {\n        return this._isOutOfBoundary();\n    }\n    get scrollAnchor() {\n        let offset = this.getScrollOffset();\n        let max = this.getMaxScrollOffset();\n        return v2(max.x == 0 ? 0 : offset.x / max.x, max.y == 0 ? 0 : 1 - offset.y / max.y);\n    }\n\n    protected _getHowMuchOutOfBoundary(addition?: Vec3): Vec3 {\n        if (this.isInfinity)\n            return v3();\n        else\n            return super._getHowMuchOutOfBoundary(addition);\n    }\n    protected _calculateMovePercentDelta(options): Vec3 {\n        const anchor = options.anchor;\n        const applyToHorizontal = options.applyToHorizontal;\n        const applyToVertical = options.applyToVertical;\n        // eslint-disable-next-line @typescript-eslint/no-this-alias\n        const self = this;\n        self._calculateBoundary();\n        //取消了anchor.clampf\n        let bottomDelta = self._getContentBottomBoundary() - self._bottomBoundary;\n        bottomDelta = -bottomDelta;\n\n        let leftDelta = self._getContentLeftBoundary() - self._leftBoundary;\n        leftDelta = -leftDelta;\n\n        const moveDelta = new Vec3();\n        if (self._content && self.view) {\n            let totalScrollDelta = 0;\n            const uiTrans = self._content.getComponent(UITransform)!;\n            const contentSize = uiTrans.contentSize;\n            const scrollSize = self.view.contentSize;\n            if (applyToHorizontal) {\n                totalScrollDelta = contentSize.width - scrollSize.width;\n                moveDelta.x = leftDelta - totalScrollDelta * anchor.x;\n            }\n            if (applyToVertical) {\n                totalScrollDelta = contentSize.height - scrollSize.height;\n                moveDelta.y = bottomDelta - totalScrollDelta * anchor.y;\n            }\n        }\n\n        return moveDelta;\n    }\n    protected _processAutoScrolling(dt: any): void {\n        const self = this;\n\n        const isAutoScrollBrake = self._isNecessaryAutoScrollBrake();\n        const brakingFactor = isAutoScrollBrake ? 0.05 : 1;\n        self._autoScrollAccumulatedTime += dt * (1 / brakingFactor);\n\n        let percentage = Math.min(1, self._autoScrollAccumulatedTime / self._autoScrollTotalTime);\n        if (self._autoScrollAttenuate) {\n            percentage = easing.quintOut(percentage);\n        }\n\n        const clonedAutoScrollTargetDelta = self._autoScrollTargetDelta.clone();\n        clonedAutoScrollTargetDelta.multiplyScalar(percentage);\n        const clonedAutoScrollStartPosition = self._autoScrollStartPosition.clone();\n        clonedAutoScrollStartPosition.add(clonedAutoScrollTargetDelta);\n        let reachedEnd = Math.abs(percentage - 1) <= EPSILON;\n\n        const fireEvent = Math.abs(percentage - 1) <= self.getScrollEndedEventTiming();\n        if (fireEvent && !self._isScrollEndedWithThresholdEventFired) {\n            self._dispatchEvent(ScrollView.EventType.SCROLL_ENG_WITH_THRESHOLD);\n            self._isScrollEndedWithThresholdEventFired = true;\n        }\n\n        if (self.elastic) {\n            const brakeOffsetPosition = clonedAutoScrollStartPosition.clone();\n            brakeOffsetPosition.subtract(self._autoScrollBrakingStartPosition);\n            if (isAutoScrollBrake) {\n                brakeOffsetPosition.multiplyScalar(brakingFactor);\n            }\n            clonedAutoScrollStartPosition.set(self._autoScrollBrakingStartPosition);\n            clonedAutoScrollStartPosition.add(brakeOffsetPosition);\n        } else {\n            const moveDelta = clonedAutoScrollStartPosition.clone();\n            moveDelta.subtract(self.getContentPosition());\n            const outOfBoundary = self._getHowMuchOutOfBoundary(moveDelta);\n            if (!outOfBoundary.equals(Vec3.ZERO, EPSILON)) {\n                clonedAutoScrollStartPosition.add(outOfBoundary);\n                reachedEnd = true;\n            }\n        }\n\n        if (reachedEnd) {\n            self._autoScrolling = false;\n        }\n\n        const deltaMove = clonedAutoScrollStartPosition.clone();\n        deltaMove.subtract(self.content.position);\n        self._clampDelta(deltaMove);\n        self._moveContent(deltaMove, reachedEnd);\n        if (deltaMove.length() > EPSILON)\n            self._dispatchEvent(ScrollView.EventType.SCROLLING);\n\n        if (!self._autoScrolling) {\n            self._isBouncing = false;\n            self._scrolling = false;\n            self._dispatchEvent(ScrollView.EventType.SCROLL_ENDED);\n            self.node.emit(FixedScrollView.FINISH_AUTO_SCROLL);\n        }\n    }\n\n    protected _clampDelta(out: Vec3): void {\n        if (!this.isInfinity)\n            super._clampDelta(out);\n    }\n\n    protected _handleReleaseLogic(touch: Touch): void {\n        // eslint-disable-next-line @typescript-eslint/no-this-alias\n        const self = this;\n\n        self._getLocalAxisAlignDelta(self._deltaPos, touch);\n        self._gatherTouchMove(self._deltaPos);\n        if (self.isHandleReleaseScroll || this._isOutOfBoundary())\n            self._processInertiaScroll();\n\n        if (self._scrolling) {\n            self._scrolling = false;\n            if (!self._autoScrolling) {\n                self._dispatchEvent(ScrollView.EventType.SCROLL_ENDED);\n            }\n        }\n    }\n    protected _onTouchBegan(event: EventTouch, captureListeners?: Node[]): void {\n        this.isInTouch = true;\n        if (!this.allowTouch)\n            return;\n        super._onTouchBegan(event, captureListeners);\n    }\n    protected _onTouchMoved(event: EventTouch, captureListeners?: Node[]): void {\n        if (!this.allowTouch)\n            return;\n        super._onTouchMoved(event, captureListeners);\n\n    }\n    protected _onTouchCancelled(event: EventTouch, captureListeners?: Node[]): void {\n        this.isInTouch = false;\n        if (!this.allowTouch)\n            return;\n        super._onTouchCancelled(event, captureListeners);\n        if (event && !event.simulate) {\n            this._dispatchEvent(ScrollView.EventType.TOUCH_UP);\n        }\n    }\n    protected _onTouchEnded(event: EventTouch, captureListeners?: Node[]): void {\n        this.isInTouch = false;\n        if (!this.allowTouch)\n            return;\n        super._onTouchEnded(event, captureListeners);\n    }\n\n    protected _hasNestedViewGroup(event: any, captureListeners?: Node[]): boolean {\n        // if (!event || event.eventPhase !== Event.CAPTURING_PHASE) {\n        //     return false;\n        // }\n\n        // if (captureListeners) {\n        //     // captureListeners are arranged from child to parent\n        //     for (let i = 0; i < captureListeners.length; i++) {\n        //         const listener = captureListeners[i];\n        //         if (this.node === listener) {\n        //             if (event.target && (event.target as Node).getComponent(ViewGroup)) {\n        //                 return true;\n        //             }\n        //             return false;\n        //         }\n\n        //         if (listener.getComponent(ViewGroup)) {\n        //             return true;\n        //         }\n        //     }\n        // }\n        return false;\n    }\n}\n\n\n"]}